--CLTOTFIL tablosu Cari hesap aylık toplamlarını ifade eder
SELECT  CL.CODE AS CHCODE,   CL.DEFINITION_ AS 'Unvan', 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '0' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Acilis_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '0' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Acilis_Alacak, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '1' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Ocak_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '1' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Ocak_Alacak, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '2' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Subat_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '2' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Subat_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '3' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Mart_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '3' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Mart_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '4' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Nisan_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '4' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Nisan_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '5' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Mayıs_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '5' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Mayıs_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '6' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Haziran_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '6' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Haziran_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '7' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Temmuz_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '7' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Temmuz_Alacak, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '8' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Ağustos_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '8' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Ağustos_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '9' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Eylül_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '9' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Eylül_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '10' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Ekim_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '10' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Ekim_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '11' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Kasım_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '11' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Kasım_Alacak,
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '12' THEN LV_004_01_CLTOTFIL.DEBIT ELSE 0 END) AS Aralık_Borc, 
SUM(CASE WHEN LV_004_01_CLTOTFIL.MONTH_ = '12' THEN LV_004_01_CLTOTFIL.CREDIT ELSE 0 END) AS Aralık_Alacak,

SUM(dbo.LV_004_01_CLTOTFIL.DEBIT) AS TOPLAMBORÇ,
SUM(dbo.LV_004_01_CLTOTFIL.CREDIT) AS TOPLAMALACAK,
SUM(dbo.LV_004_01_CLTOTFIL.DEBIT-CREDIT) AS BAKIYE,
CONVERT(NVARCHAR(20), (SELECT TOP 1 DATE_ FROM LG_004_01_INVOICE AS STL WHERE  STL.CLIENTREF=CL.LOGICALREF ORDER BY DATE_ DESC),105) AS [SON SATIS TARIHI],
CONVERT(NVARCHAR(20), (SELECT TOP 1  CLF.DATE_  FROM  LV_004_01_CLFLINE AS CLF WHERE CLF.CLIENTREF=CL.LOGICALREF AND MODULENR<>4 ORDER BY CLF.DATE_ DESC),105) AS  [SON TAHSILAT TARİHİ]
FROM  LV_004_01_CLTOTFIL INNER JOIN
      LV_004_CLCARD AS CL ON LV_004_01_CLTOTFIL.CARDREF = CL.LOGICALREF
WHERE     (CL.ACTIVE = 0) AND TOTTYP=1 
GROUP BY CL.DEFINITION_,CL.CODE,CL.LOGICALREF
ORDER BY CHCODE ASC
